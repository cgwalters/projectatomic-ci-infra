# This job serves as the gate for PR testing. The GHPRB plugin is used to track
# whitelisted authors and PR states to determine when a PR should be tested. It
# must be instantiated once per repo to gate.

- job-template:
    name: 'ghprb-gate-{ghowner}-{ghrepo}'
    description: |
        JJB Code Location: https://github.com/jlebon/projectatomic-ci-infra<br>
        Managed by Jenkins Job Builder. Do not edit via web.<br>
    concurrent: false
    node: master
    wrappers:
      - timestamps
    properties:
      - github: # required by GHPRB
          url: 'https://github.com/{ghowner}/{ghrepo}'
    triggers:
      - github-pull-request:

          github-hooks: true
          auth-id: '7a64217f-077c-4fde-a9a3-fd0ae37d4e0a'

          white-list: [ '{white-list}' ]
          org-list: [ 'projectatomic openshift flatpak ostreedev' ]
          allow-whitelist-orgs-as-admins: true

          # This doesn't actually matter since we don't do any status updates
          # from this job. EXCEPT if this trigger job itself failed somehow,
          # which it should never.
          status-context: 'GHPRB Gate Job'
          failure-status: 'Internal error while triggering.'
          error-status: 'Internal error while triggering.'

          # We want no URLs nor updates except if something has gone wrong.
          # https://github.com/jenkinsci/ghprb-plugin/pull/182
          # All status updates are performed by the triggered pipeline
          status-url: '--none--'
          triggered-status: '--none--'
          started-status: '--none--'
          success-status: '--none--'

          trigger-phrase: 'bot, retest this please'
    builders:
      - shell: 'env | sort'
    publishers:
      - email-ext:
          recipients: 'jlebon@redhat.com'
          reply-to: 'jlebon@redhat.com'
          failure: false
          first-failure: true
          fixed: true

- job-group:
    name: ghprb-gate-jobs
    jobs:
        - 'ghprb-gate-{ghowner}-{ghrepo}'

# Sigh, because of the whitelist issue, we can't collapse these and just
# enumerate on the ghrepo:
#
# https://github.com/jenkinsci/ghprb-plugin/issues/382
#
# The whitelist files in this repo get populated by a Groovy script during job
# redefinitions.

- project:
    jobs: [ ghprb-gate-jobs ]
    name: jlebon-papr-sandbox-gate
    ghowner: jlebon
    ghrepo: papr-sandbox
    white-list: !include-raw: ghprb-gate-jlebon-papr-sandbox.whitelist
